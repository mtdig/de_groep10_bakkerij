<!DOCTYPE html>
<html lang="{{ lang }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bread & Bytes</title>
    <script src="https://unpkg.com/htmx.org@2.0.3"></script>
    <meta name="htmx-config" content='{"allowScriptTags":true}'>
    <link rel="stylesheet" href="/styles.css">
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <div class="logo">
                <img src="/img/bakkerij_logo.svg" alt="Bread Bytes Logo">
                <span>Bread & Bytes</span>
            </div>
            <button class="hamburger" onclick="toggleMenu()" aria-label="Toggle menu">
                <span></span>
                <span></span>
                <span></span>
            </button>
            <div class="nav-links" id="navLinks">
                <a href="/?lang={{ lang }}" 
                   hx-get="/?lang={{ lang }}" 
                   hx-target="#main-content" 
                   hx-swap="innerHTML" 
                   hx-push-url="true"
                   {% if page == 'home' %}class="active"{% endif %}>{{ t.home }}</a>
                <a href="/products?lang={{ lang }}" 
                   hx-get="/products?lang={{ lang }}" 
                   hx-target="#main-content" 
                   hx-swap="innerHTML" 
                   hx-push-url="true"
                   {% if page == 'products' %}class="active"{% endif %}>{{ t.products }}</a>
                <a href="/account?lang={{ lang }}" 
                   hx-get="/account?lang={{ lang }}" 
                   hx-target="#main-content" 
                   hx-swap="innerHTML" 
                   hx-push-url="true"
                   {% if page == 'account' %}class="active"{% endif %}>{{ t.account }}</a>
                <a href="/cart?lang={{ lang }}" 
                   hx-get="/cart?lang={{ lang }}" 
                   hx-target="#main-content" 
                   hx-swap="innerHTML" 
                   hx-push-url="true"
                   class="cart-link {% if page == 'cart' %}active{% endif %}">
                    <svg class="cart-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="9" cy="21" r="1"></circle>
                        <circle cx="20" cy="21" r="1"></circle>
                        <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
                    </svg>
                    <span id="cart-badge" hx-get="/cart/count?lang={{ lang }}" hx-trigger="cartUpdate from:body" hx-swap="innerHTML">{% if cartCount > 0 %}<span class="cart-count">{{ cartCount }}</span>{% endif %}</span>
                </a>
                <select class="lang-dropdown" onchange="updateLanguage(this.value)">
                    <option value="nl" {% if lang == 'nl' %}selected{% endif %}>ðŸ‡³ðŸ‡± NL</option>
                    <option value="fr" {% if lang == 'fr' %}selected{% endif %}>ðŸ‡«ðŸ‡· FR</option>
                    <option value="en" {% if lang == 'en' %}selected{% endif %}>ðŸ‡¬ðŸ‡§ EN</option>
                    <option value="de" {% if lang == 'de' %}selected{% endif %}>ðŸ‡©ðŸ‡ª DE</option>
                    <option value="es" {% if lang == 'es' %}selected{% endif %}>ðŸ‡ªðŸ‡¸ ES</option>
                    <option value="zh" {% if lang == 'zh' %}selected{% endif %}>ðŸ‡¨ðŸ‡³ ä¸­æ–‡</option>
                </select>
            </div>
        </div>
    </nav>

    <script>
        const translations = {{ t|tojson }};
        
        function toggleMenu() {
            const navLinks = document.getElementById('navLinks');
            const hamburger = document.querySelector('.hamburger');
            navLinks.classList.toggle('active');
            hamburger.classList.toggle('active');
        }

        function updateLanguage(lang) {
            const currentPath = window.location.pathname;
            const searchParams = new URLSearchParams(window.location.search);
            searchParams.set('lang', lang);
            window.location.href = currentPath + '?' + searchParams.toString();
        }

        // Update active nav link after HTMX navigation
        document.body.addEventListener('htmx:afterSwap', function(evt) {
            if (evt.detail.target.id === 'main-content') {
                // Remove active class from all nav links
                document.querySelectorAll('.nav-links a').forEach(link => {
                    link.classList.remove('active');
                });
                
                // Add active class to the clicked link
                const triggeringElement = evt.detail.elt;
                if (triggeringElement && triggeringElement.tagName === 'A') {
                    triggeringElement.classList.add('active');
                }
            }
        });

        function showCartModal(lang, type, productName, quantity, price) {
            const modal = document.getElementById('cart-action-modal');
            const title = document.getElementById('modal-title');
            const message = document.getElementById('modal-message');
            const btnContinue = document.getElementById('modal-btn-continue');
            const btnCart = document.getElementById('modal-btn-cart');
            const productDetails = document.getElementById('modal-product-details');
            
            if (type === 'repeat') {
                title.textContent = translations.order_added;
                message.textContent = translations.order_added_msg;
                productDetails.style.display = 'none';
            } else {
                title.textContent = translations.product_added;
                message.textContent = translations.product_added_msg;
                
                if (productName && quantity) {
                    document.getElementById('product-detail-label').textContent = translations.product_label;
                    document.getElementById('quantity-detail-label').textContent = translations.quantity_label;
                    document.getElementById('price-detail-label').textContent = translations.price_label;
                    document.getElementById('product-name').textContent = productName;
                    document.getElementById('product-quantity').textContent = quantity;
                    document.getElementById('product-price').textContent = 'â‚¬' + (price * quantity).toFixed(2);
                    productDetails.style.display = 'block';
                } else {
                    productDetails.style.display = 'none';
                }
            }
            btnContinue.textContent = translations.continue_shopping;
            btnCart.textContent = translations.cart;
            
            btnCart.href = '/cart?lang=' + lang;
            modal.style.display = 'flex';
        }

        function closeCartModal() {
            document.getElementById('cart-action-modal').style.display = 'none';
        }

        // Listen for HTMX trigger event
        document.body.addEventListener('showCartModal', function(evt) {
            showCartModal(evt.detail.lang, evt.detail.type, evt.detail.productName, evt.detail.quantity, evt.detail.price);
        });

        // Payment processing function
        window.processPayment = function(method) {
            const urlParams = new URLSearchParams(window.location.search);
            const lang = urlParams.get('lang') || 'nl';
            
            // For cash payment, skip the modal and go directly to success
            if (method === 'cash') {
                window.location.href = '/payment/success?lang=' + lang + '&method=cash';
                return;
            }
            
            const modal = document.getElementById('payment-modal');
            const statusEl = document.getElementById('payment-status');
            const methodNameEl = document.getElementById('payment-method-name');
            const countdownEl = document.getElementById('countdown');
            
            if (!modal) {
                console.error('Payment modal not found');
                return;
            }
            
            // Store payment method in session storage
            sessionStorage.setItem('lastPaymentMethod', method);
            
            // Show modal
            modal.style.display = 'flex';
            
            // Set method name
            const methodNames = {
                'mollie': 'Mollie',
                'paypal': 'PayPal',
                'bancontact': 'Bancontact',
                'bnp': 'BNP Paribas',
                'ideal': 'iDEAL',
                'visa': 'Visa/Mastercard'
            };
            methodNameEl.textContent = methodNames[method] || method;
            
            // Countdown from 5
            let count = 5;
            countdownEl.textContent = count;
            
            const interval = setInterval(() => {
                count--;
                if (count > 0) {
                    countdownEl.textContent = count;
                } else {
                    clearInterval(interval);
                    
                    // Check if this is a retry (from failed payment)
                    const isRetry = urlParams.get('retry') === 'true';
                    
                    // Always succeed on retry, otherwise random
                    const success = isRetry ? true : Math.random() > 0.5;
                    
                    if (success) {
                        window.location.href = '/payment/success?lang=' + lang;
                    } else {
                        window.location.href = '/payment/failed?lang=' + lang + '&method=' + method;
                    }
                }
            }, 1000);
        };
    </script>

    <div id="main-content">
    {% block main %}
    {% endblock %}
    </div>

    <!-- Cart Action Modal -->
    <div id="cart-action-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-icon">âœ“</div>
            <h2 id="modal-title"></h2>
            <p id="modal-message"></p>
            <div id="modal-product-details" class="modal-product-details" style="display: none;">
                <div class="product-detail-row">
                    <span class="product-detail-label" id="product-detail-label"></span>
                    <span class="product-detail-value" id="product-name"></span>
                </div>
                <div class="product-detail-row">
                    <span class="product-detail-label" id="quantity-detail-label"></span>
                    <span class="product-detail-value" id="product-quantity"></span>
                </div>
                <div class="product-detail-row">
                    <span class="product-detail-label" id="price-detail-label"></span>
                    <span class="product-detail-value" id="product-price"></span>
                </div>
            </div>
            <div class="modal-buttons">
                <button class="btn-secondary" onclick="closeCartModal()" id="modal-btn-continue"></button>
                <a href="#" class="btn-primary" id="modal-btn-cart"></a>
            </div>
        </div>
    </div>

    <!-- Product Details Modal -->
    <div id="product-details-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content product-details-modal-content">
            <div class="modal-header">
                <h2 id="product-modal-title">{{ t.product_details }}</h2>
                <button class="modal-close-btn" onclick="closeProductDetailsModal()">Ã—</button>
            </div>
            <div id="product-modal-body" class="product-modal-body">
                <!-- Content loaded dynamically -->
            </div>
            <div class="modal-buttons">
                <button class="btn-primary" onclick="closeProductDetailsModal()">{{ t.close }}</button>
            </div>
        </div>
    </div>

    <script>
        window.showProductDetails = function(productId, lang) {
            fetch(`/product/details/${productId}?lang=${lang}`)
                .then(response => response.json())
                .then(data => {
                    const langSuffix = lang.charAt(0).toUpperCase() + lang.slice(1);
                    const modalBody = document.getElementById('product-modal-body');
                    
                    // Find product image by product ID
                    let productImage = '';
                    const productCard = document.querySelector(`.product-card[data-product-id="${productId}"]`);
                    if (productCard) {
                        const img = productCard.querySelector('img[data-product-image]');
                        if (img) {
                            productImage = img.getAttribute('data-product-image');
                        }
                    }
                    
                    let html = `
                        <div class="product-detail-header">
                            ${productImage ? `<img src="${productImage}" alt="${data['name' + langSuffix]}" class="product-detail-image">` : ''}
                            <div class="product-detail-section">
                                <h3>${data['name' + langSuffix]}</h3>
                                <p class="product-detail-description">${data['description' + langSuffix]}</p>
                            </div>
                        </div>
                        
                        <div class="product-detail-grid">
                            <div class="product-detail-item">
                                <strong>{{ t.weight }}:</strong> ${data.weight}
                            </div>
                            <div class="product-detail-item">
                                <strong>{{ t.calories }}:</strong> ${data.calories}
                            </div>
                        </div>
                        
                        <div class="product-detail-section">
                            <h4>{{ t.main_ingredients }}</h4>
                            <p>${data['mainIngredients' + langSuffix]}</p>
                        </div>
                        
                        <div class="product-detail-section">
                            <h4>{{ t.allergens }}</h4>
                            <p class="allergens-warning">${data['allergens' + langSuffix]}</p>
                        </div>
                        
                        <div class="product-detail-section">
                            <h4>{{ t.nutrition_per_100g }}</h4>
                            <table class="nutrition-table">
                                <tr><td>{{ t.energy }}</td><td>${data.nutritionPer100g.energy}</td></tr>
                                <tr><td>{{ t.fat }}</td><td>${data.nutritionPer100g.fat}</td></tr>
                                <tr><td>{{ t.saturated_fat }}</td><td>${data.nutritionPer100g.saturatedFat}</td></tr>
                                <tr><td>{{ t.carbohydrates }}</td><td>${data.nutritionPer100g.carbohydrates}</td></tr>
                                <tr><td>{{ t.sugars }}</td><td>${data.nutritionPer100g.sugars}</td></tr>
                                <tr><td>{{ t.fiber }}</td><td>${data.nutritionPer100g.fiber}</td></tr>
                                <tr><td>{{ t.protein }}</td><td>${data.nutritionPer100g.protein}</td></tr>
                                <tr><td>{{ t.salt }}</td><td>${data.nutritionPer100g.salt}</td></tr>
                            </table>
                        </div>
                        
                        <div class="product-detail-section">
                            <h4>{{ t.health_info }}</h4>
                            <p>${data['healthInfo' + langSuffix]}</p>
                        </div>
                        
                        <div class="product-detail-section">
                            <h4>{{ t.storage }}</h4>
                            <p>${data['storage' + langSuffix]}</p>
                        </div>
                    `;
                    
                    modalBody.innerHTML = html;
                    document.getElementById('product-details-modal').style.display = 'flex';
                })
                .catch(error => {
                    console.error('Error loading product details:', error);
                    alert('Failed to load product details');
                });
        };
        
        window.closeProductDetailsModal = function() {
            document.getElementById('product-details-modal').style.display = 'none';
        };
        
        // Close modal when clicking outside
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('product-details-modal');
            if (event.target === modal) {
                closeProductDetailsModal();
            }
        });
    </script>

    <footer class="footer">
        <p>&copy; 2025 De Groep10 Bakkerij. {{ t.all_rights_reserved }} | v{{ version }}</p>
    </footer>
</body>
</html>
